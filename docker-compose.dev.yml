services:
  squidward-db:
    image: postgres:17.6-alpine3.22
    restart: unless-stopped
    container_name: squidward-db
    hostname: squidward-db
    environment:
      POSTGRES_HOST_FILE: /run/secrets/postgres_host
      POSTGRES_PORT_FILE: /run/secrets/postgres_port
      POSTGRES_DB_FILE: /run/secrets/postgres_db
      POSTGRES_USER_FILE: /run/secrets/postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      TZ: ${TZ}
      PGTZ: ${TZ}
    networks:
      - squidward-network-internal
      - squidward-network-external # DEV ONLY
    ports:
      - '5437:5432'
    volumes:
      - squidward-db-vol:/var/lib/postgresql/data
    secrets:
      - postgres_host
      - postgres_port
      - postgres_db
      - postgres_user
      - postgres_password

  squidward-redis:
    image: valkey/valkey:9.0-alpine3.22
    container_name: squidward-redis
    hostname: squidward-redis
    restart: always
    networks:
      - squidward-network-internal
      - squidward-network-external # DEV ONLY
    ports:
      - '6389:6379'
    volumes:
      - squidward-redis-vol:/data
    environment:
      - VALKEY_PASSWORD_FILE=/run/secrets/valkey-password
    secrets:
      - redis_password
    healthcheck:
      test: [ 'CMD', 'valkey-cli', 'ping' ]
      interval: 3s
      timeout: 10s
      retries: 3

volumes:
  squidward-db-vol:
    driver: local
    external: false
    name: squidward-db-vol
  squidward-redis-vol:
    driver: local
    external: false
    name: squidward-redis-vol

networks:
  squidward-network-internal:
    name: squidward-network-internal
    internal: true
    external: false
  squidward-network-external:
    name: squidward-network-external
    driver: bridge

secrets:
  postgres_host:
    environment: POSTGRES_HOST
  postgres_port:
    environment: POSTGRES_PORT
  postgres_db:
    environment: POSTGRES_DB
  postgres_user:
    environment: POSTGRES_USER
  postgres_password:
    environment: POSTGRES_PASSWORD
  redis_password:
    environment: REDIS_PASSWORD